<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/logo.ico">
    <title>Wordcloud</title>
    <link rel="stylesheet" href="/style.css">

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.1.2/src/wordcloud2.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>

    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        main.card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            margin-bottom: 20px;
            font-weight: 700;
            color: #1a73e8;
        }

        .controls {
            margin-bottom: 20px;
            justify-content: center !important;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            margin: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        .help-icon {
            float: right;
            display: inline-block;
            margin-left: 8px;
            color: #1a73e8;
            cursor: pointer;
            font-weight: bold;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: #e0f0ff;
            transition: background 0.2s;
        }

        .help-icon:hover {
            background: #cce0ff;
        }

        .tooltip {
            display: none;
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a73e8;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            line-height: 1.4;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: transparent transparent #1a73e8 transparent;
        }

        /* CLOUD + QR PANEL */
        .cloud-wrapper {
            display: flex;
            width: 100%;
            height: 450px;
            position: relative;
        }

        #cloud {
            flex: 1 1 100%;
            border: 1px solid #ddd;
            border-radius: 8px 0 0 8px;
            height: 100%;
            transition: flex 0.35s ease;
        }

        .qr-panel {
            flex: 0 0 0%;
            max-width: 0;
            overflow: hidden;
            background: #fafafa;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: flex 0.35s ease, max-width 0.35s ease;
            padding-top: 20px;
        }

        .qr-panel.open {
            flex: 0 0 260px;
            max-width: 260px;
        }

        #qrcode {
            width: 220px;
            height: 220px;
        }

        .toggle-btn {
            position: absolute;
            top: 0px;
            right: 0px;
            width: 28px;
            height: 28px;

            border: none;
            background: #1a73e8;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: transform 0.25s;
        }

        .toggle-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>

<body>

    <main class="card">

        <div style="text-align: center;">
            <img src="/logo.png" alt="Logo" style="width: 50%; max-width: 200px; height: auto;">
            <span class="help-icon" id="helpIcon">?</span>
        </div>

        <div class="tooltip" id="tooltip">
            Nueva nube para crear un nuevo QR y conectar usuarios asociados a una pregunta.
            Una vez conectados los usuarios, no debe refrescar más. Puedes ir añadiendo nuevas preguntas sin crear
            nuevas nubes.
            El usuario solo puede añadir una palabra por pregunta, máximo un espacio y 25 caracteres.
        </div>

        <div class="controls">
            <button id="createBtn">Crear nube</button>
            <div id="sessionBox" class="hidden">
                <p style="display: none">Session ID: <strong id="sessionId"></strong></p>
            </div>
        </div>
        <div id="game" style="display:none">
            <p>URL: <a id="sessionUrl"></a></p>

            <h1>Pregunta actual: <span id="question">N/A</span></h1>



            <div id="cloudWrapper" class="cloud-wrapper">
                <canvas id="cloud"></canvas>

                <aside id="qrPanel" class="qr-panel">
                    <div id="qrcode"></div>
                </aside>

                <button id="toggleQR" class="toggle-btn">></button>
            </div>
            <p style="display:flex; gap:20px; justify-content:center; align-items:center; font-size:18px">
                <span style="display:flex; align-items:center; gap:6px">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z" />
                    </svg>
                    <span id="count">0</span>
                </span>

                <span style="display:flex; align-items:center; gap:6px">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path d="M4 4h16v12H5.17L4 17.17V4zm2 4v2h12V8H6zm0 4v2h8v-2H6z" />
                    </svg>
                    <span id="wordCount">0</span>
                </span>

                <button id="newQuestionBtn" style="display:none;">Nueva pregunta</button>

            </p>
        </div>
        <footer style="text-align: center; padding: 15px 0; font-size: 0.9rem; color: #666;">
            Creado por <a href="https://www.linkedin.com/in/carlosserranosanchez/" target="_blank"
                style="color:#1a73e8;">
                Carlos Serrano
            </a>
        </footer>

    </main>

    <script>
        const helpIcon = document.getElementById('helpIcon');
        const tooltip = document.getElementById('tooltip');
        const qrPanel = document.getElementById('qrPanel');
        const toggleQR = document.getElementById('toggleQR');
        const cloud = document.getElementById('cloud');

        helpIcon.addEventListener('click', () => {
            tooltip.style.display = tooltip.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (!helpIcon.contains(e.target) && !tooltip.contains(e.target)) tooltip.style.display = 'none';
        });

        // Función para redimensionar y renderizar el canvas
        function resizeCloud() {
            const wrapper = cloud.parentElement;
            cloud.width = wrapper.clientWidth - (qrPanel.classList.contains('open') ? qrPanel.offsetWidth : 0);
            cloud.height = wrapper.clientHeight;
            if (window.lastCloudData) {
                renderWordCloud(window.lastCloudData, { canvas: cloud });
            }
        }

        // Abrir/cerrar panel QR
        function setQR(open) {
            if (open) {
                qrPanel.classList.add('open');
                toggleQR.textContent = '>';
            } else {
                qrPanel.classList.remove('open');
                toggleQR.textContent = '<';
            }
            setTimeout(resizeCloud, 360); // esperar la transición
        }

        // Toggle manual
        toggleQR.addEventListener('click', () => {
            setQR(!qrPanel.classList.contains('open'));
        });

        // Abrir QR automáticamente al cargar QR
        document.addEventListener('qr-loaded', () => {
            setQR(true);
        });

        // Redibujar al cambiar tamaño de ventana
        window.addEventListener('resize', resizeCloud);

        window.APP_ROLE = 'organizer';
    </script>


    <script src="/app.js"></script>

</body>

</html>